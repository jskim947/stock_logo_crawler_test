---
globs: *.sql,*.py
description: Database schema and operation rules
---
## Database Rules

### Schema Reference
- Always reference [DATABASE.md](mdc:DATABASE.md) for schema definitions.
- Use `logo_master` materialized view, not `tickers` table.
- `logo_hash` is MD5 (32 characters) generated from `sprovider`, `fs_entity_id`, or `infomax_code`.
- Use `fs_exchange` field, not the deprecated "팩셋거래소".

### Table Structure
- `logos`: Main logo metadata table with `logo_hash` as unique key.
- `logo_files`: File metadata for original and converted images.
- `logo_deletion_logs`: Audit log for deletions.
- `ext_api_quota`: API quota management.

### Connection Management
- Use psycopg2-binary for PostgreSQL connections.
- Implement proper connection pooling.
- Use context managers for database operations.
- Handle connection errors gracefully.

### Query Patterns
- Use parameterized queries to prevent SQL injection.
- Implement proper indexing for performance.
- Use transactions for data consistency.
- Follow the master data query patterns in [MASTER_DATA.md](mdc:MASTER_DATA.md).

### Data Integrity
- Use foreign key constraints where appropriate.
- Implement proper validation at database level.
- Use CHECK constraints for data validation.
- Maintain referential integrity.